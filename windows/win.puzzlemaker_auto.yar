rule win_puzzlemaker_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2022-10-07"
        version = "1"
        description = "Detects win.puzzlemaker."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.puzzlemaker"
        malpedia_rule_date = "20221007"
        malpedia_hash = "597f9539014e3d0f350c069cd804aa71679486ae"
        malpedia_version = "20221010"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 4c8d0d05a30000 488be9 4c8d05f3a20000 488d15f4a20000 b901000000 e8???????? }
            // n = 6, score = 100
            //   4c8d0d05a30000       | xor                 dword ptr [eax], ecx
            //   488be9               | je                  0x242
            //   4c8d05f3a20000       | inc                 eax
            //   488d15f4a20000       | dec                 ecx
            //   b901000000           | add                 eax, 2
            //   e8????????           |                     

        $sequence_1 = { 488d157c160200 c705????????01000000 48c705????????01000000 48891d???????? }
            // n = 4, score = 100
            //   488d157c160200       | dec                 eax
            //   c705????????01000000     |     
            //   48c705????????01000000     |     
            //   48891d????????       |                     

        $sequence_2 = { eb02 33c0 488d4808 488d1502c00100 e8???????? 85c0 }
            // n = 6, score = 100
            //   eb02                 | dec                 eax
            //   33c0                 | mov                 ecx, ebx
            //   488d4808             | dec                 eax
            //   488d1502c00100       | lea                 eax, [0x143b5]
            //   e8????????           |                     
            //   85c0                 | dec                 eax

        $sequence_3 = { 428a8c01c8640100 482bd0 8b42fc d3e8 49895108 41894118 0fb60a }
            // n = 7, score = 100
            //   428a8c01c8640100     | dec                 edx
            //   482bd0               | mov                 edx, dword ptr [eax + 0x22bf0]
            //   8b42fc               | inc                 edx
            //   d3e8                 | mov                 cl, byte ptr [edx + esi*8 + 0x3d]
            //   49895108             | test                cl, 4
            //   41894118             | je                  0x1ad2
            //   0fb60a               | inc                 edx

        $sequence_4 = { 488b0d???????? 48894c0420 b808000000 486bc001 488b0d???????? 48894c0420 488d0da93c0100 }
            // n = 7, score = 100
            //   488b0d????????       |                     
            //   48894c0420           | sub                 edx, eax
            //   b808000000           | mov                 ebx, dword ptr [edx - 4]
            //   486bc001             | shr                 ebx, cl
            //   488b0d????????       |                     
            //   48894c0420           | and                 ecx, 0xf
            //   488d0da93c0100       | dec                 edx

        $sequence_5 = { 57 4883ec20 8bfa 4c8d0d25a00000 }
            // n = 4, score = 100
            //   57                   | cmp                 eax, edi
            //   4883ec20             | dec                 eax
            //   8bfa                 | sbb                 ecx, ecx
            //   4c8d0d25a00000       | dec                 eax

        $sequence_6 = { eb19 488d3d5e400100 eb10 488d3d65400100 eb07 488d3d44400100 }
            // n = 6, score = 100
            //   eb19                 | dec                 eax
            //   488d3d5e400100       | mov                 eax, ebx
            //   eb10                 | dec                 eax
            //   488d3d65400100       | add                 esp, 0x20
            //   eb07                 | pop                 ebx
            //   488d3d44400100       | ret                 

        $sequence_7 = { 41894118 0fb60a 83e10f 4a0fbe8401b8640100 428a8c01c8640100 482bd0 8b42fc }
            // n = 7, score = 100
            //   41894118             | call                edx
            //   0fb60a               | test                eax, eax
            //   83e10f               | jns                 0x1594
            //   4a0fbe8401b8640100     | dec    eax
            //   428a8c01c8640100     | lea                 ecx, [ebp - 0x11]
            //   482bd0               | dec                 ecx
            //   8b42fc               | mov                 edx, ebp

        $sequence_8 = { 4803fe e9???????? 0fb606 498bd5 482bd6 4a0fbebc38f0180200 8d4f01 }
            // n = 7, score = 100
            //   4803fe               | dec                 esp
            //   e9????????           |                     
            //   0fb606               | lea                 eax, [0xa12e]
            //   498bd5               | dec                 eax
            //   482bd6               | mov                 edi, ecx
            //   4a0fbebc38f0180200     | dec    eax
            //   8d4f01               | lea                 edx, [0x87e4]

        $sequence_9 = { 4154 4155 4157 488dac24c8faffff 4881ec38060000 }
            // n = 5, score = 100
            //   4154                 | lea                 ebx, [0xffffc7bd]
            //   4155                 | dec                 esp
            //   4157                 | mov                 dword ptr [ecx + 8], eax
            //   488dac24c8faffff     | dec                 esp
            //   4881ec38060000       | mov                 ecx, ecx

    condition:
        7 of them and filesize < 331776
}