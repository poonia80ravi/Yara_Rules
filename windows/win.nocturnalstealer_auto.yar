rule win_nocturnalstealer_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2022-10-07"
        version = "1"
        description = "Detects win.nocturnalstealer."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.nocturnalstealer"
        malpedia_rule_date = "20221007"
        malpedia_hash = "597f9539014e3d0f350c069cd804aa71679486ae"
        malpedia_version = "20221010"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { ce 52 5c 96 121b d9782f 13f9 }
            // n = 7, score = 100
            //   ce                   | into                
            //   52                   | push                edx
            //   5c                   | pop                 esp
            //   96                   | xchg                eax, esi
            //   121b                 | adc                 bl, byte ptr [ebx]
            //   d9782f               | fnstcw              word ptr [eax + 0x2f]
            //   13f9                 | adc                 edi, ecx

        $sequence_1 = { 89f9 5f 294c2408 59 e9???????? 8f0424 e9???????? }
            // n = 7, score = 100
            //   89f9                 | mov                 ecx, edi
            //   5f                   | pop                 edi
            //   294c2408             | sub                 dword ptr [esp + 8], ecx
            //   59                   | pop                 ecx
            //   e9????????           |                     
            //   8f0424               | pop                 dword ptr [esp]
            //   e9????????           |                     

        $sequence_2 = { ff3424 e9???????? 57 ff742404 5f 8f0424 8b2424 }
            // n = 7, score = 100
            //   ff3424               | push                dword ptr [esp]
            //   e9????????           |                     
            //   57                   | push                edi
            //   ff742404             | push                dword ptr [esp + 4]
            //   5f                   | pop                 edi
            //   8f0424               | pop                 dword ptr [esp]
            //   8b2424               | mov                 esp, dword ptr [esp]

        $sequence_3 = { e9???????? ff0424 c1242403 81042439939f53 e9???????? 810424e2aa549b e9???????? }
            // n = 7, score = 100
            //   e9????????           |                     
            //   ff0424               | inc                 dword ptr [esp]
            //   c1242403             | shl                 dword ptr [esp], 3
            //   81042439939f53       | add                 dword ptr [esp], 0x539f9339
            //   e9????????           |                     
            //   810424e2aa549b       | add                 dword ptr [esp], 0x9b54aae2
            //   e9????????           |                     

        $sequence_4 = { e9???????? e8???????? ff3424 8b0424 50 e9???????? 8b0c24 }
            // n = 7, score = 100
            //   e9????????           |                     
            //   e8????????           |                     
            //   ff3424               | push                dword ptr [esp]
            //   8b0424               | mov                 eax, dword ptr [esp]
            //   50                   | push                eax
            //   e9????????           |                     
            //   8b0c24               | mov                 ecx, dword ptr [esp]

        $sequence_5 = { ff3424 5b 81c404000000 83ebff e9???????? 01c7 81ef577dfb7f }
            // n = 7, score = 100
            //   ff3424               | push                dword ptr [esp]
            //   5b                   | pop                 ebx
            //   81c404000000         | add                 esp, 4
            //   83ebff               | sub                 ebx, -1
            //   e9????????           |                     
            //   01c7                 | add                 edi, eax
            //   81ef577dfb7f         | sub                 edi, 0x7ffb7d57

        $sequence_6 = { ff3424 5b 83c404 50 b804000000 e9???????? 56 }
            // n = 7, score = 100
            //   ff3424               | push                dword ptr [esp]
            //   5b                   | pop                 ebx
            //   83c404               | add                 esp, 4
            //   50                   | push                eax
            //   b804000000           | mov                 eax, 4
            //   e9????????           |                     
            //   56                   | push                esi

        $sequence_7 = { e9???????? 83c304 871c24 5c 81c704000000 e9???????? 8b3c24 }
            // n = 7, score = 100
            //   e9????????           |                     
            //   83c304               | add                 ebx, 4
            //   871c24               | xchg                dword ptr [esp], ebx
            //   5c                   | pop                 esp
            //   81c704000000         | add                 edi, 4
            //   e9????????           |                     
            //   8b3c24               | mov                 edi, dword ptr [esp]

        $sequence_8 = { e8???????? ebd1 8bc8 c1f905 8d3c8da09e4c00 8bf0 83e61f }
            // n = 7, score = 100
            //   e8????????           |                     
            //   ebd1                 | jmp                 0xffffffd3
            //   8bc8                 | mov                 ecx, eax
            //   c1f905               | sar                 ecx, 5
            //   8d3c8da09e4c00       | lea                 edi, [ecx*4 + 0x4c9ea0]
            //   8bf0                 | mov                 esi, eax
            //   83e61f               | and                 esi, 0x1f

        $sequence_9 = { e9???????? 01f8 8b3c24 e9???????? 81fff8a3ffff 0f8576feffff fb }
            // n = 7, score = 100
            //   e9????????           |                     
            //   01f8                 | add                 eax, edi
            //   8b3c24               | mov                 edi, dword ptr [esp]
            //   e9????????           |                     
            //   81fff8a3ffff         | cmp                 edi, 0xffffa3f8
            //   0f8576feffff         | jne                 0xfffffe7c
            //   fb                   | sti                 

    condition:
        7 of them and filesize < 10739712
}