rule RAN_BlackMatter_Dec_2021_1
{
    meta:
        description = "Detect the BlackMatter implant"
        author = "Arkbird_SOLG"
        date = "2021-12-19"
        reference = "Internal Research"
        hash1 = "70344ece62a828c46ff315b3328125d8ab5f690af2bbeaa24224fee97142ee6ad9"
        hash2 = "2aad85dbd4c79bd21c6218892552d5c9fb216293a251559ba59d45d56a01437c"
	hash3 = "730f2d6243055c786d737bae0665267b962c64f57132e9ab401d6e7625c3d0a4"
	hash4 = "8eada5114fbbc73b7d648b38623fc206367c94c0e76cb3b395a33ea8859d2952"
        tlp = "Clear"
        adversary = "BlackMatter"
    strings:
        $s1 = { 8d 85 70 ff ff ff 83 c0 0f 83 e0 f0 89 85 b8 fe ff ff 8d 85 e0 fe ff ff 83 c0 0f 83 e0 f0 89 85 b4 fe ff ff 8d 85 c0 fe ff ff 83 c0 0f 83 e0 f0 89 85 bc fe ff ff 8b 75 08 8b bd b8 fe ff ff 0f 10 06 0f 10 4e 10 0f 10 56 20 0f 10 5e 30 0f 10 66 40 0f 10 6e 50 0f 10 76 60 8b 46 70 8b 4e 74 8b 56 78 8b 9d bc fe ff ff 89 03 89 4b 04 89 53 08 d1 c0 c1 c9 03 d1 c2 33 c1 33 c2 89 43 0c 0f 10 3b 66 0f 7f 07 66 0f 7f 4f 10 66 0f 7f 57 20 66 0f 7f 5f 30 66 0f 7f 47 40 66 0f 7f 4f 50 66 0f 7f 57 60 66 0f 7f 5f 70 81 7d 14 80 00 00 00 73 5b 66 0f ef c0 8b 85 b4 fe ff ff 66 0f 7f 00 66 0f 7f 40 10 66 0f 7f 40 20 66 0f 7f 40 30 66 0f 7f 40 40 66 0f 7f 40 50 66 0f 7f 40 60 66 0f 7f 40 70 8b 95 b4 fe ff ff 8b 5d 0c 8b 4d 14 8a 44 0b ff 88 44 0a ff 49 85 c9 75 f3 8b 5d 10 89 55 0c 89 55 10 8b }
        $s2 = { 8d 85 70 ff ff ff 83 c0 0f 83 e0 f0 89 85 6c ff ff ff 8b 85 6c ff ff ff c7 00 00 00 00 00 c7 40 04 00 00 00 00 c7 40 08 00 00 00 00 c7 40 0c 00 00 00 00 c7 40 10 00 00 00 00 c7 40 14 00 00 00 00 c7 40 18 00 00 00 00 c7 40 1c 00 00 00 00 c7 40 20 00 00 00 00 c7 40 24 00 00 00 00 c7 40 28 00 00 00 00 c7 40 2c 00 00 00 00 c7 40 30 00 00 00 00 c7 40 34 00 00 00 00 c7 40 38 00 00 00 00 c7 40 3c 00 00 00 00 c7 40 40 00 00 00 00 c7 40 44 00 00 00 00 c7 40 48 00 00 00 00 c7 40 4c 00 00 00 00 c7 40 50 00 00 00 00 c7 40 54 00 00 00 00 c7 40 58 00 00 00 00 c7 40 5c 00 00 00 00 c7 40 60 00 00 00 00 c7 40 64 00 00 00 00 c7 40 68 00 00 00 00 c7 40 6c 00 00 00 00 c7 40 70 00 00 00 00 c7 40 74 00 00 00 00 c7 40 78 00 00 00 00 c7 40 7c 00 00 00 00 c7 85 68 ff ff ff 00 04 00 00 8b 85 6c ff ff ff f8 d1 10 d1 50 04 d1 50 08 d1 50 0c d1 50 10 d1 50 14 d1 50 18 d1 50 1c d1 50 20 d1 50 24 d1 50 28 d1 50 2c d1 50 30 d1 50 34 d1 50 38 d1 50 3c d1 50 40 d1 50 44 d1 50 48 d1 50 4c d1 50 50 d1 50 54 d1 50 58 d1 50 5c d1 50 60 d1 50 64 d1 50 68 d1 50 6c d1 50 70 d1 50 74 d1 50 78 d1 50 7c 8b 85 6c ff ff ff 8b 4d 10 f8 8b 11 8b 59 04 8b 71 08 8b 79 0c 19 10 19 58 04 19 70 08 19 78 0c 8b 51 10 8b 59 14 8b 71 18 8b 79 1c 19 50 10 19 58 14 19 70 18 19 78 1c 8b 51 20 8b 59 24 8b 71 28 8b 79 }
        $s3 = { 8d 85 f0 fd ff ff 50 e8 ?? 89 ff ff 8d 45 f8 c7 00 53 00 2d 00 c7 40 04 2a 00 00 00 50 8d 85 f0 fd ff ff 50 ff 15 ?? 4d [2] 83 c4 08 6a 00 6a 00 6a 00 8d 85 a0 fb ff ff 50 6a 00 8d 85 f0 fd ff ff 50 ff 15 ?? 4e [2] 89 45 fc 83 7d fc ff 74 5b 8b 85 a0 fb ff ff 66 a9 10 00 74 32 6a 5c 8d 85 f0 fd ff ff 50 ff 15 ?? 4d [2] 83 c4 08 8d 8d cc fb ff ff 51 8d 40 02 50 ff 15 ?? 4d [2] 83 c4 08 8d 85 f0 fd ff ff 50 e8 00 01 00 00 8d 85 a0 fb ff ff 50 ff 75 fc ff 15 ?? 4e }
        $s4 = { 8b 08 89 0d ?? 3f [2] 50 e8 [2] ff ff 68 ?? 3f [2] 68 ?? 45 [2] e8 [2] ff ff 68 ?? 3f [2] 68 ?? 46 [2] e8 [2] ff ff 68 ?? 3f [2] 68 ?? 46 [2] e8 [2] ff ff 68 ?? 3f [2] 68 ?? 47 [2] e8 [2] ff ff 68 ?? 3f [2] 68 ?? 47 [2] e8 [2] ff ff 68 ?? 3f [2] 68 ?? 48 [2] e8 [2] ff ff 68 ?? 3f [2] 68 ?? 48 [2] e8 [2] ff ff 68 ?? 3f [2] 68 ?? 49 [2] e8 [2] ff ff 68 ?? 3f [2] 68 ?? 49 [2] e8 [2] ff ff 68 ?? 3f [2] 68 ?? 4a [2] e8 [2] ff ff 6a 7c 68 ?? 45 [2] 68 ?? 40 [2] ff 15 ?? 4d [2] 83 c4 0c 6a 7c 68 ?? 46 [2] 68 ?? 41 [2] ff 15 ?? 4d [2] 83 c4 0c 6a 7c 68 ?? 46 [2] 68 ?? 41 [2] ff 15 ?? 4d [2] 83 c4 0c 6a 7c 68 ?? 47 [2] 68 ?? 42 [2] ff 15 ?? 4d [2] 83 c4 0c 6a 7c 68 ?? 47 [2] 68 ?? 42 [2] ff 15 ?? 4d [2] 83 c4 0c 6a 7c 68 ?? 48 [2] 68 ?? 43 [2] ff 15 ?? 4d [2] 83 c4 0c 6a 7c 68 ?? 48 [2] 68 ?? 43 [2] ff 15 ?? 4d [2] 83 c4 0c 6a 7c 68 ?? 49 [2] 68 ?? 44 [2] ff 15 ?? 4d [2] 83 c4 0c 6a 7c 68 ?? 49 [2] 68 ?? 44 [2] ff 15 ?? 4d [2] 83 c4 0c 6a 7c 68 ?? 4a [2] 68 ?? 45 [2] ff 15 ?? 4d [2] 83 c4 0c b8 00 00 20 00 a3 ?? 40 [2] d1 e0 a3 ?? 41 [2] d1 e0 a3 ?? 41 [2] d1 e0 a3 ?? 42 [2] d1 e0 a3 ?? 42 [2] d1 e0 a3 ?? 43 [2] d1 e0 a3 ?? 43 [2] d1 e0 a3 ?? 44 [2] d1 e0 a3 ?? 44 [2] d1 }
    condition:
       uint16(0) == 0x5A4D and filesize > 30KB and all of ($s*) 
}
