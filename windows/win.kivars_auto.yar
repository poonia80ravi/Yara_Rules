rule win_kivars_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2022-10-07"
        version = "1"
        description = "Detects win.kivars."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.kivars"
        malpedia_rule_date = "20221007"
        malpedia_hash = "597f9539014e3d0f350c069cd804aa71679486ae"
        malpedia_version = "20221010"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 7e77 837c242803 7e22 488d442441 4c8bc8 41b804000000 }
            // n = 6, score = 200
            //   7e77                 | dec                 eax
            //   837c242803           | mov                 ecx, dword ptr [esp + 0x260]
            //   7e22                 | movzx               eax, byte ptr [ecx + eax]
            //   488d442441           | add                 eax, dword ptr [esp + 0x120]
            //   4c8bc8               | and                 eax, 0xff
            //   41b804000000         | jg                  0x1c

        $sequence_1 = { c68424381700009a c684243917000086 c684243a170000a2 c684243b17000098 }
            // n = 4, score = 200
            //   c68424381700009a     | dec                 eax
            //   c684243917000086     | lea                 edx, [esp + 0x574]
            //   c684243a170000a2     | dec                 eax
            //   c684243b17000098     | lea                 ecx, [esp + 0x250]

        $sequence_2 = { 55 89442410 8d4c240c 89442414 56 668944241c b365 }
            // n = 7, score = 200
            //   55                   | mov                 dword ptr [esp + eax*4 + 0x44], ecx
            //   89442410             | dec                 eax
            //   8d4c240c             | cmp                 dword ptr [esp + 0x28], 0
            //   89442414             | je                  0x22
            //   56                   | mov                 byte ptr [esp + 0x69], 0x14
            //   668944241c           | mov                 byte ptr [esp + 0x6a], 0x15
            //   b365                 | mov                 byte ptr [esp + 0x6b], 0x16

        $sequence_3 = { 48ffc0 48898424b0100000 8b8424e8100000 ffc8 898424b8100000 33c0 }
            // n = 6, score = 200
            //   48ffc0               | mov                 eax, dword ptr [esp + 0x278]
            //   48898424b0100000     | cmp                 dword ptr [esp + 0x244], eax
            //   8b8424e8100000       | jge                 0x3b
            //   ffc8                 | dec                 eax
            //   898424b8100000       | arpl                word ptr [esp + 0x244], ax
            //   33c0                 | dec                 eax

        $sequence_4 = { c644246914 c644246a15 c644246b16 c644246c17 c644246d18 c644246e19 884c246f }
            // n = 7, score = 200
            //   c644246914           | dec                 eax
            //   c644246a15           | lea                 eax, [esp + 0x41]
            //   c644246b16           | dec                 esp
            //   c644246c17           | mov                 ecx, eax
            //   c644246d18           | inc                 ecx
            //   c644246e19           | mov                 eax, 4
            //   884c246f             | mov                 byte ptr [esp + 0x471], 0x31

        $sequence_5 = { 89842444020000 8b842478020000 39842444020000 7d2b 4863842444020000 }
            // n = 5, score = 200
            //   89842444020000       | mov                 byte ptr [esp + 0x1738], 0x9a
            //   8b842478020000       | mov                 byte ptr [esp + 0x1739], 0x86
            //   39842444020000       | mov                 byte ptr [esp + 0x173a], 0xa2
            //   7d2b                 | mov                 byte ptr [esp + 0x173b], 0x98
            //   4863842444020000     | mov                 dword ptr [esp + 0x244], eax

        $sequence_6 = { c684247104000031 c684247204000084 c6842473040000eb c684247404000025 c6842475040000a6 }
            // n = 5, score = 200
            //   c684247104000031     | dec                 eax
            //   c684247204000084     | arpl                word ptr [esp + 0x2c], ax
            //   c6842473040000eb     | dec                 eax
            //   c684247404000025     | mov                 ecx, dword ptr [esp + 0x278]
            //   c6842475040000a6     | movsx               eax, byte ptr [ecx + eax]

        $sequence_7 = { 4c8b8c24c0060000 4c8d442430 488d942474050000 488d8c2450020000 e8???????? }
            // n = 5, score = 200
            //   4c8b8c24c0060000     | dec                 esp
            //   4c8d442430           | mov                 ecx, dword ptr [esp + 0x6c0]
            //   488d942474050000     | dec                 esp
            //   488d8c2450020000     | lea                 eax, [esp + 0x30]
            //   e8????????           |                     

        $sequence_8 = { c644243074 884c2431 c64424326f c64424336e c644243400 c644243500 }
            // n = 6, score = 200
            //   c644243074           | mov                 dword ptr [esp + 0x14], eax
            //   884c2431             | push                esi
            //   c64424326f           | mov                 word ptr [esp + 0x1c], ax
            //   c64424336e           | mov                 bl, 0x65
            //   c644243400           | add                 esp, 8
            //   c644243500           | mov                 esi, dword ptr [esp + 0x18]

        $sequence_9 = { 48630424 488b8c2460020000 0fb60401 03842420010000 25ff000000 }
            // n = 5, score = 200
            //   48630424             | inc                 eax
            //   488b8c2460020000     | dec                 eax
            //   0fb60401             | mov                 dword ptr [esp + 0x10b0], eax
            //   03842420010000       | mov                 eax, dword ptr [esp + 0x10e8]
            //   25ff000000           | dec                 eax

        $sequence_10 = { 8bce 89442458 e8???????? 8d442430 8d4c2440 50 6a14 }
            // n = 7, score = 200
            //   8bce                 | mov                 ebx, dword ptr [esp + 0x58]
            //   89442458             | rep movsd           dword ptr es:[edi], dword ptr [esi]
            //   e8????????           |                     
            //   8d442430             | cmp                 ebx, 1
            //   8d4c2440             | push                ebp
            //   50                   | mov                 dword ptr [esp + 0x10], eax
            //   6a14                 | lea                 ecx, [esp + 0xc]

        $sequence_11 = { 83c408 8b742418 8b13 6a03 8bcb }
            // n = 5, score = 200
            //   83c408               | mov                 byte ptr [esp + 0x6c], 0x17
            //   8b742418             | mov                 byte ptr [esp + 0x6d], 0x18
            //   8b13                 | mov                 byte ptr [esp + 0x6e], 0x19
            //   6a03                 | mov                 byte ptr [esp + 0x6f], cl
            //   8bcb                 | lea                 edi, [esp + 0xc]

        $sequence_12 = { 8db42490010000 8d3c10 8bd1 c1e902 }
            // n = 4, score = 200
            //   8db42490010000       | mov                 edx, dword ptr [ebx]
            //   8d3c10               | push                3
            //   8bd1                 | mov                 ecx, ebx
            //   c1e902               | mov                 ecx, esi

        $sequence_13 = { 7f1a 486344242c 488b8c2478020000 0fbe0401 }
            // n = 4, score = 200
            //   7f1a                 | mov                 dword ptr [esp + 0x10b8], eax
            //   486344242c           | xor                 eax, eax
            //   488b8c2478020000     | dec                 eax
            //   0fbe0401             | arpl                word ptr [esp], ax

        $sequence_14 = { 8d7c240c 8b5c2458 f3a5 83fb01 }
            // n = 4, score = 200
            //   8d7c240c             | mov                 byte ptr [esp + 0x472], 0x84
            //   8b5c2458             | mov                 byte ptr [esp + 0x473], 0xeb
            //   f3a5                 | mov                 byte ptr [esp + 0x474], 0x25
            //   83fb01               | mov                 byte ptr [esp + 0x475], 0xa6

        $sequence_15 = { 85f6 75c9 85db 750d 6860ea0000 ff15???????? eba0 }
            // n = 7, score = 200
            //   85f6                 | mov                 dword ptr [esp + 0x58], eax
            //   75c9                 | lea                 eax, [esp + 0x30]
            //   85db                 | lea                 ecx, [esp + 0x40]
            //   750d                 | push                eax
            //   6860ea0000           | push                0x14
            //   ff15????????         |                     
            //   eba0                 | mov                 byte ptr [esp + 0x30], 0x74

    condition:
        7 of them and filesize < 196608
}