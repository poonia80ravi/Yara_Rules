rule RAN_Hive_Dec_2021_1 {
   meta:
        description = "Detect Hive ransomware"
        author = "Arkbird_SOLG"
        reference = "Internal Research"
        date = "2021-12-21"
        hash1 = "33aceb3dc0681a56226d4cfce32eee7a431e66f5c746a4d6dc7506a72b317277"
        hash2 = "3489cfa46b9cc21f3fbd73d3225b1f42223a9c14bec10c8d305f72192314a372"
        hash3 = "28518da0336e8e2e48f598dc23d6312e8567f1d088d3b20993f643a8f0e1c6ad"
        hash4 = "693e43e6524610a91f66f692325ff3aead9c426d587c2dcfda7c9c15773f1895"
        hash5 = "6920e86a65fc94f9fd46c46c09187b802a13801904e06c6aa63c10e0c9197218"
        hash6 = "be1565961e123f52e54e350e0ca2666f8ffa42fdc46df18dca6f7c0ac2b43d23"
        tlp = "Clear"
        adversary = "Hive"
   strings:
        $s1 = { 48 89 44 24 40 48 8b 05 [3] 00 48 89 04 24 44 0f 11 7c 24 08 44 0f 11 7c 24 18 e8 [2] 00 00 45 0f 57 ff 65 4c 8b 34 25 28 00 00 00 4d 8b b6 00 00 00 00 48 8b 44 24 28 48 8b 4c 24 40 48 89 81 38 03 00 00 48 85 c0 75 24 48 8d 05 [3] 00 48 89 04 24 e8 [2] 02 00 45 0f 57 ff 65 4c 8b 34 25 28 00 00 00 4d 8b b6 00 00 00 00 48 8b 05 [3] 00 48 89 04 24 44 0f 11 7c 24 08 44 0f 11 7c 24 18 e8 [2] 00 00 45 0f 57 ff 65 4c 8b 34 25 28 00 00 00 4d 8b b6 00 00 00 00 48 8b 44 24 28 48 8b 4c 24 40 48 89 81 40 03 00 00 48 85 c0 75 6d 48 8d 05 [3] 00 48 89 04 24 0f 1f 40 00 e8 [2] 02 00 45 0f 57 ff 65 4c 8b 34 25 28 00 00 00 4d 8b b6 00 00 00 00 48 8b 05 [3] 00 48 8b 4c 24 40 48 8b 91 38 03 00 00 48 89 04 24 48 89 54 24 08 e8 [2] 00 00 45 0f 57 ff 65 4c 8b 34 25 28 00 00 00 4d 8b b6 00 00 00 00 48 8b 44 24 40 48 }
        $s2 = { 48 83 ec ?? 48 89 6c 24 ?? 48 8d 6c 24 ?? 31 c0 48 8d 0d [3] 00 ba 01 00 00 00 f0 0f b1 11 0f 94 c1 84 c9 74 47 48 8b 05 [3] 00 48 8b 0d [3] 00 48 89 0c 24 48 89 44 24 08 44 0f 11 7c 24 10 48 c7 44 24 20 00 00 00 00 e8 [2] 00 00 45 0f 57 ff 65 4c 8b 34 25 28 00 00 00 4d 8b b6 00 00 00 00 48 83 7c 24 28 00 74 0a 48 8b 6c 24 ?? 48 83 c4 ?? c3 e8 [3] 00 45 0f 57 ff 65 4c 8b 34 25 28 00 00 00 4d 8b b6 00 00 00 00 }
        $s3 = { 48 81 ec ?? 00 00 00 48 89 ac 24 ?? 00 00 00 48 8d ac 24 ?? 00 00 00 48 c7 44 24 48 00 00 00 00 48 8b 05 [3] 00 48 8d 4c 24 48 48 89 04 24 48 c7 44 24 08 ff ff ff ff 48 c7 44 24 10 fe ff ff ff 48 c7 44 24 18 ff ff ff ff 48 89 4c 24 20 44 0f 11 7c 24 28 48 c7 44 24 38 02 00 00 00 e8 2d ?? 00 00 45 0f 57 ff 65 4c 8b 34 25 28 00 00 00 4d 8b b6 00 00 00 00 48 83 7c 24 40 00 0f 84 [2] 00 00 49 8b 4e 30 48 89 8c 24 ?? 00 00 00 84 01 48 8d 81 28 03 00 00 48 89 84 24 ?? 00 00 00 90 e8 [2] fd ff 48 8b 4c 24 48 48 8b 94 24 ?? 00 00 00 48 89 8a 30 03 00 00 48 83 ba 48 03 00 00 00 75 62 80 3d [3] 00 00 74 59 48 8b 05 [3] 00 48 89 04 24 44 0f 11 7c 24 08 48 c7 44 24 18 02 00 00 00 48 c7 44 24 20 03 00 10 00 e8 1b ?? 00 00 45 0f 57 ff 65 4c 8b 34 25 28 00 00 00 4d 8b b6 00 00 00 00 48 8b 44 24 28 48 8b 8c 24 ?? 00 00 00 48 89 81 48 03 00 00 48 85 c0 0f 84 ?? 01 00 00 90 90 48 8b 84 24 ?? 00 00 00 e8 [2] fd ff 48 8d 4c 24 ?? 44 0f 11 39 48 8d 54 24 ?? 44 0f 11 3a 48 8d ?? 24 }
        $s4 = { 48 8b 05 [3] 00 48 89 04 24 48 c7 44 24 08 f4 ff ff ff e8 [2] 00 00 45 0f 57 ff 65 4c 8b 34 25 28 00 00 00 4d 8b b6 00 00 00 00 48 8b 44 24 10 8b 4c 24 68 48 8b 5c 24 60 eb 3b 48 8b 05 [3] 00 48 89 04 24 48 c7 44 24 08 f5 ff ff ff e8 [2] 00 00 45 0f 57 ff 65 4c 8b 34 25 28 00 00 00 4d 8b b6 00 00 00 00 48 8b 44 24 10 8b 4c 24 68 48 8b 5c 24 60 84 03 48 63 f1 48 81 fe 00 00 00 40 0f 87 ea 00 00 00 31 d2 eb 03 48 ff c2 48 39 f2 7d 7f 0f b6 3c 13 40 80 ff 80 72 ee 48 89 44 24 40 c7 44 24 3c 00 00 00 00 48 8b 0d [3] 00 48 8d 54 24 3c 48 89 0c 24 48 89 44 24 08 48 89 54 24 10 e8 [2] 00 00 45 0f 57 ff 65 4c 8b 34 25 28 00 00 00 4d 8b b6 00 00 00 00 48 83 7c 24 18 00 75 10 48 8b 44 24 40 8b 4c 24 68 48 8b 5c 24 60 eb 1d 48 8b 44 24 40 48 8b 5c 24 60 8b 4c 24 68 e8 8f 00 00 00 48 8b 6c 24 48 48 83 c4 50 c3 c7 44 24 38 00 00 00 00 48 8b 15 [3] 00 48 8d 74 24 38 48 89 14 24 48 89 44 24 08 48 89 5c 24 10 48 63 c1 48 89 44 24 18 48 89 74 24 20 48 c7 44 24 28 00 00 00 00 e8 [2] 00 00 45 0f 57 ff 65 4c 8b 34 25 28 00 00 00 4d 8b b6 00 00 00 00 8b 44 24 38 48 8b 6c 24 }
        $s5 = { 62 75 63 6b 65 74 5b 78 35 30 39 2e 45 78 74 4b 65 79 55 73 61 67 65 5d 5b 5d 75 69 6e 74 38 00 25 2a 6d 61 70 2e 62 75 63 6b 65 74 5b 63 72 79 70 74 6f 2e 48 61 73 68 5d 61 73 6e 31 2e 52 61 77 56 61 6c 75 65 00 25 2a 6d 61 70 2e 62 75 63 6b 65 74 5b 64 6e 73 6d 65 73 73 61 67 65 2e 73 65 63 74 69 6f 6e 5d 73 74 72 69 6e 67 00 25 2a 6d 61 70 5b 63 68 61 6e 3c 2d 20 6f 73 2e 53 69 67 6e 61 6c 5d 2a 73 69 67 6e 61 6c 2e 68 61 6e 64 6c 65 72 }
   condition:
        uint16(0) == 0x5A4D and filesize > 600KB and all of ($s*) 
}

