rule win_nightsky_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2022-10-07"
        version = "1"
        description = "Detects win.nightsky."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.nightsky"
        malpedia_rule_date = "20221007"
        malpedia_hash = "597f9539014e3d0f350c069cd804aa71679486ae"
        malpedia_version = "20221010"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 48895c2410 4889742418 57 4881ec20080000 488bf1 4c8d4108 488d4c2420 }
            // n = 7, score = 100
            //   48895c2410           | inc                 ecx
            //   4889742418           | cmp                 bl, 0xe1
            //   57                   | inc                 ebp
            //   4881ec20080000       | test                ch, bh
            //   488bf1               | neg                 edi
            //   4c8d4108             | stc                 
            //   488d4c2420           | dec                 eax

        $sequence_1 = { 4c8d151478ffff 498bf4 498bce 490f42f7 e8???????? 8bf8 85c0 }
            // n = 7, score = 100
            //   4c8d151478ffff       | inc                 ebp
            //   498bf4               | xor                 ecx, ecx
            //   498bce               | dec                 eax
            //   490f42f7             | mov                 ebp, dword ptr [esp + 0x34]
            //   e8????????           |                     
            //   8bf8                 | dec                 esp
            //   85c0                 | mov                 esi, dword ptr [esp + 0x2c]

        $sequence_2 = { 448811 c0cd17 66c1e196 f8 418b08 4080fd86 }
            // n = 6, score = 100
            //   448811               | inc                 cx
            //   c0cd17               | mov                 edi, ebp
            //   66c1e196             | inc                 ecx
            //   f8                   | btr                 edx, 0x6c
            //   418b08               | dec                 esp
            //   4080fd86             | mov                 ebx, esp

        $sequence_3 = { 440fb6c1 49c1e910 4c897df0 44896550 478b848510710500 }
            // n = 5, score = 100
            //   440fb6c1             | and                 ch, 0xff
            //   49c1e910             | test                di, 0x1491
            //   4c897df0             | bts                 bp, si
            //   44896550             | pop                 ebp
            //   478b848510710500     | stc                 

        $sequence_4 = { e9???????? 493bec 0f84be000000 8b7500 33c0 f04d0fb1bcf180210500 488bd8 }
            // n = 7, score = 100
            //   e9????????           |                     
            //   493bec               | jge                 0x394
            //   0f84be000000         | dec                 eax
            //   8b7500               | mov                 ecx, eax
            //   33c0                 | dec                 eax
            //   f04d0fb1bcf180210500     | lea    ecx, [0x51b38]
            //   488bd8               | inc                 ecx

        $sequence_5 = { c7470801000000 488d05a78b0200 48894718 48b90000000000000080 48c7471008000000 488d055a890200 48894730 }
            // n = 7, score = 100
            //   c7470801000000       | dec                 ecx
            //   488d05a78b0200       | mov                 ebp, esp
            //   48894718             | inc                 eax
            //   48b90000000000000080     | test    dh, dh
            //   48c7471008000000     | dec                 eax
            //   488d055a890200       | lea                 eax, [0x26010]
            //   48894730             | add                 edx, dword ptr [eax + ecx*4]

        $sequence_6 = { 488d05464d0300 c7476801000000 48c7477006000000 48898790000000 c7878000000001000000 }
            // n = 5, score = 100
            //   488d05464d0300       | cmp                 byte ptr [ecx + 8], bl
            //   c7476801000000       | dec                 eax
            //   48c7477006000000     | sub                 esp, 0x20
            //   48898790000000       | xor                 ebx, ebx
            //   c7878000000001000000     | dec    eax

        $sequence_7 = { c7475001000000 48c7475806000000 48894778 488d05c2560300 c7476801000000 48c7477006000000 48898790000000 }
            // n = 7, score = 100
            //   c7475001000000       | mov                 dword ptr [ebp - 0x39], eax
            //   48c7475806000000     | dec                 eax
            //   48894778             | lea                 eax, [0x9d1b]
            //   488d05c2560300       | dec                 eax
            //   c7476801000000       | mov                 dword ptr [ebp - 0x31], eax
            //   48c7477006000000     | dec                 eax
            //   48898790000000       | mov                 dword ptr [ebp - 0x29], eax

        $sequence_8 = { 488d842420070000 448bc6 442bc0 488d05a53c0100 4489742440 4c8b742450 4c8d4c2448 }
            // n = 7, score = 100
            //   488d842420070000     | mov                 edi, dword ptr [ebx + 0x18]
            //   448bc6               | inc                 ecx
            //   442bc0               | movzx               edi, dx
            //   488d05a53c0100       | inc                 eax
            //   4489742440           | sar                 bh, cl
            //   4c8b742450           | dec                 esp
            //   4c8d4c2448           | sub                 ecx, ecx

        $sequence_9 = { ffc2 f9 f5 d1c2 80fb20 6641f7c1647e 664585cf }
            // n = 7, score = 100
            //   ffc2                 | dec                 eax
            //   f9                   | shr                 ebx, 0x10
            //   f5                   | inc                 ecx
            //   d1c2                 | xor                 esi, dword ptr [ebp + ecx*4 + 0x56910]
            //   80fb20               | inc                 ecx
            //   6641f7c1647e         | movzx               ecx, bl
            //   664585cf             | inc                 ecx

    condition:
        7 of them and filesize < 19536896
}