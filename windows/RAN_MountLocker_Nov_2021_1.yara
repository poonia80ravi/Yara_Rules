rule RAN_MountLocker_Nov_2021_1
{
   meta:
        description = "Detect the Mountlocker ransomware (implant reused in Quantum Locker)"
        author = "Arkbird_SOLG"
        reference = "Internal Research"
        date = "2021-11-13"
        hash1 = "4a5ac3c6f8383cc33c795804ba5f7f5553c029bbb4a6d28f1e4d8fb5107902c1"
        hash2 = "6143d920ebdd5e9b1db7425916417c0896139f425493a8fcd63d62dac80779f1"
        hash3 = "00ed4c347cd62526226363a0aceb851b2ef7e3a4da78433a28f2cd6cbd5f1b99"
        tlp = "Clear"
        adversary = "MountLocker"
   strings:      
        $s1 = { 48 21 4d 77 4c 8d 05 ?? 40 00 00 48 21 4d 6f 45 8b ce 48 8d 4d 77 44 89 7d 67 33 d2 c7 44 24 20 00 00 00 f0 ff 15 ?? 3b 00 00 85 c0 0f 84 ?? 02 00 00 48 8b 4d 77 48 8d 45 6f 48 89 44 24 28 48 8d 3d ?? 9a 00 00 83 64 24 20 00 48 8b d7 45 33 c9 41 b8 14 01 00 00 ff 15 [2] 00 00 8b d8 85 c0 74 3b 48 8b 4d 6f 48 8d 45 67 c7 44 24 30 00 01 00 00 45 33 c9 48 89 44 24 28 45 8b c6 48 8d 05 [2] 00 00 33 d2 48 89 44 24 20 ff 15 [2] 00 00 48 8b 4d 6f 8b d8 ff 15 [2] 00 00 48 8b 4d 77 33 d2 ff 15 [2] 00 00 85 db 0f 84 ?? 01 00 00 48 8d 0d ?? 9b 00 00 44 89 7d 67 48 89 0d ?? dc 00 00 33 db ff 15 [2] 00 00 48 63 c8 48 8d 55 67 48 89 0d ?? dc 00 00 48 8d 4d 97 ff 15 [2] 00 00 f7 d8 1b c9 23 4d 67 8b c1 89 4d 67 48 83 f8 0f 73 16 48 8d 4d 97 41 8a d7 44 8d 43 0f 48 03 c8 4c 2b c0 e8 ?? 23 00 00 32 c0 88 45 a6 33 c9 02 44 0d 97 88 45 a6 48 0f be 84 39 18 01 00 00 48 03 d8 30 5c 0d 97 49 03 ce 48 83 }
        $s2 = { 0f b7 85 c4 00 00 00 48 8d 15 ?? 5f 00 00 44 8b 4d b8 41 8b ce 44 8b 45 b4 89 44 24 28 8b 45 bc 89 44 24 20 e8 44 0f 00 00 45 33 c9 48 8d 54 24 30 45 8d 41 0c 41 8d 49 01 ff 15 ?? 2d 00 00 85 c0 75 22 66 83 7c 24 30 09 48 8d 15 ?? 5f 00 00 b8 40 00 00 00 41 8b ce 44 8d 40 e0 44 0f 44 c0 e8 08 0f 00 00 bb fa 00 00 00 48 8d 95 00 03 00 00 48 8d 8d d0 00 00 00 89 9d 00 03 00 00 ff 15 ?? 29 00 00 85 c0 74 24 8b 85 00 03 00 00 4c 8d 85 d0 00 00 00 48 8d 15 ?? 5f 00 00 41 8b ce 66 89 b4 45 d0 00 00 00 e8 c1 0e 00 00 48 8d 95 00 03 00 00 89 9d 00 03 00 00 48 8d 8d d0 00 00 00 ff 15 [2] 00 00 85 c0 74 24 8b 85 00 03 00 00 4c 8d 85 d0 00 00 00 48 8d 15 ?? 5f 00 00 41 8b ce 66 89 b4 45 d0 00 00 00 e8 7f 0e 00 00 4c 8d 85 08 03 00 00 89 b5 08 03 00 00 48 8d 95 10 03 00 00 48 89 b5 10 03 00 00 33 c9 ff 15 ?? 2b 00 00 85 c0 74 04 8b c6 eb 19 48 8b 8d 10 03 00 00 ff 15 ?? 2b 00 00 44 39 b5 08 03 00 00 8b c6 0f 94 c0 85 c0 48 8d 1d ?? 5e 00 00 4c 8b c3 48 8d 3d ?? 5e 00 00 4c 0f 45 c7 48 8d 15 ?? 5e 00 00 41 8b ce e8 15 0e 00 00 39 35 [2] 00 00 48 8d 15 ?? 5e 00 00 41 8b ce 48 0f 45 df 4c 8b c3 e8 f9 0d 00 00 e8 20 fc ff ff ff 15 [2] 00 00 48 8d 15 ?? 5e 00 00 41 8b ce 4c 8b c0 e8 dc 0d 00 00 48 81 c4 }
        $s3 = { 48 8d 45 f0 89 75 48 48 89 44 24 30 4c 8d 45 f8 48 8d 45 f4 48 89 75 f8 48 89 44 24 28 41 83 c9 ff 48 8d 45 48 ba 01 00 00 00 49 8b cf 48 89 44 24 20 ff 15 [2] 00 00 8b d8 85 c0 74 07 3d ea 00 00 00 75 7b 8b 4d 48 8b fe 85 c9 74 60 8b c7 4c 8d 04 40 48 8b 45 f8 42 38 74 c0 08 75 45 4e 8b 04 c0 48 8d 0d ae 67 00 00 49 8b d7 e8 ee 02 00 00 49 8b d4 48 8b c8 48 8b f0 41 ff d5 44 8b f0 48 85 f6 74 14 ff 15 34 ?? 00 00 4c 8b c6 33 d2 48 8b c8 ff 15 [2] 00 00 33 f6 45 85 f6 74 0b 8b 4d 48 ff c7 3b f9 73 04 eb a2 8b de 48 8b 4d f8 ff 15 ?? 65 00 00 85 }
    condition:
         uint16(0) == 0x5a4d and filesize > 30KB and all of ($s*)     
}
