rule win_retefe_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2022-10-07"
        version = "1"
        description = "Detects win.retefe."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.retefe"
        malpedia_rule_date = "20221007"
        malpedia_hash = "597f9539014e3d0f350c069cd804aa71679486ae"
        malpedia_version = "20221010"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 6a00 6a01 ff15???????? 8bf0 85f6 7410 6a09 }
            // n = 7, score = 1200
            //   6a00                 | push                0
            //   6a01                 | push                1
            //   ff15????????         |                     
            //   8bf0                 | mov                 esi, eax
            //   85f6                 | test                esi, esi
            //   7410                 | je                  0x12
            //   6a09                 | push                9

        $sequence_1 = { 51 8bf8 ffd6 85c0 }
            // n = 4, score = 1200
            //   51                   | push                ecx
            //   8bf8                 | mov                 edi, eax
            //   ffd6                 | call                esi
            //   85c0                 | test                eax, eax

        $sequence_2 = { 68f5000000 50 ff15???????? b801000000 }
            // n = 4, score = 1200
            //   68f5000000           | push                0xf5
            //   50                   | push                eax
            //   ff15????????         |                     
            //   b801000000           | mov                 eax, 1

        $sequence_3 = { 8b4e04 33c0 83c404 394104 }
            // n = 4, score = 800
            //   8b4e04               | mov                 ecx, dword ptr [esi + 4]
            //   33c0                 | xor                 eax, eax
            //   83c404               | add                 esp, 4
            //   394104               | cmp                 dword ptr [ecx + 4], eax

        $sequence_4 = { e8???????? 6a08 e8???????? 894604 }
            // n = 4, score = 800
            //   e8????????           |                     
            //   6a08                 | push                8
            //   e8????????           |                     
            //   894604               | mov                 dword ptr [esi + 4], eax

        $sequence_5 = { e8???????? 894604 83c404 8bc6 }
            // n = 4, score = 800
            //   e8????????           |                     
            //   894604               | mov                 dword ptr [esi + 4], eax
            //   83c404               | add                 esp, 4
            //   8bc6                 | mov                 eax, esi

        $sequence_6 = { 880c10 8b4e04 40 3b4104 72ec }
            // n = 5, score = 800
            //   880c10               | mov                 byte ptr [eax + edx], cl
            //   8b4e04               | mov                 ecx, dword ptr [esi + 4]
            //   40                   | inc                 eax
            //   3b4104               | cmp                 eax, dword ptr [ecx + 4]
            //   72ec                 | jb                  0xffffffee

        $sequence_7 = { 6a54 6a2e 6acf 6ab7 6a1a 6a26 }
            // n = 6, score = 800
            //   6a54                 | push                0x54
            //   6a2e                 | push                0x2e
            //   6acf                 | push                -0x31
            //   6ab7                 | push                -0x49
            //   6a1a                 | push                0x1a
            //   6a26                 | push                0x26

        $sequence_8 = { e8???????? 8b4e04 8901 8b4e04 33c0 }
            // n = 5, score = 800
            //   e8????????           |                     
            //   8b4e04               | mov                 ecx, dword ptr [esi + 4]
            //   8901                 | mov                 dword ptr [ecx], eax
            //   8b4e04               | mov                 ecx, dword ptr [esi + 4]
            //   33c0                 | xor                 eax, eax

        $sequence_9 = { 6a43 6a59 6ad2 6ae6 6a11 6a04 6a9d }
            // n = 7, score = 800
            //   6a43                 | push                0x43
            //   6a59                 | push                0x59
            //   6ad2                 | push                -0x2e
            //   6ae6                 | push                -0x1a
            //   6a11                 | push                0x11
            //   6a04                 | push                4
            //   6a9d                 | push                -0x63

        $sequence_10 = { 6a53 6ac3 6a25 6ad0 6a0e }
            // n = 5, score = 800
            //   6a53                 | push                0x53
            //   6ac3                 | push                -0x3d
            //   6a25                 | push                0x25
            //   6ad0                 | push                -0x30
            //   6a0e                 | push                0xe

        $sequence_11 = { 6a1d 6ab9 6a90 6a31 6a3b }
            // n = 5, score = 800
            //   6a1d                 | push                0x1d
            //   6ab9                 | push                -0x47
            //   6a90                 | push                -0x70
            //   6a31                 | push                0x31
            //   6a3b                 | push                0x3b

        $sequence_12 = { 03c0 03c0 bbffffff7f 6a01 2bd8 e8???????? 83c40c }
            // n = 7, score = 800
            //   03c0                 | add                 eax, eax
            //   03c0                 | add                 eax, eax
            //   bbffffff7f           | mov                 ebx, 0x7fffffff
            //   6a01                 | push                1
            //   2bd8                 | sub                 ebx, eax
            //   e8????????           |                     
            //   83c40c               | add                 esp, 0xc

        $sequence_13 = { 53 6bd830 56 8b048da0bf4200 57 }
            // n = 5, score = 100
            //   53                   | push                ebx
            //   6bd830               | imul                ebx, eax, 0x30
            //   56                   | push                esi
            //   8b048da0bf4200       | mov                 eax, dword ptr [ecx*4 + 0x42bfa0]
            //   57                   | push                edi

        $sequence_14 = { 88049d93304300 88049d922c4300 88048d91484300 88048d90444300 }
            // n = 4, score = 100
            //   88049d93304300       | mov                 byte ptr [ebx*4 + 0x433093], al
            //   88049d922c4300       | mov                 byte ptr [ebx*4 + 0x432c92], al
            //   88048d91484300       | mov                 byte ptr [ecx*4 + 0x434891], al
            //   88048d90444300       | mov                 byte ptr [ecx*4 + 0x434490], al

        $sequence_15 = { ff742410 ffd6 ff742418 6a00 }
            // n = 4, score = 100
            //   ff742410             | push                dword ptr [esp + 0x10]
            //   ffd6                 | call                esi
            //   ff742418             | push                dword ptr [esp + 0x18]
            //   6a00                 | push                0

        $sequence_16 = { 894de0 8b049da0bf4200 0fb6440828 83e001 7469 }
            // n = 5, score = 100
            //   894de0               | mov                 dword ptr [ebp - 0x20], ecx
            //   8b049da0bf4200       | mov                 eax, dword ptr [ebx*4 + 0x42bfa0]
            //   0fb6440828           | movzx               eax, byte ptr [eax + ecx + 0x28]
            //   83e001               | and                 eax, 1
            //   7469                 | je                  0x6b

        $sequence_17 = { 750e 8b4d08 51 8b4108 }
            // n = 4, score = 100
            //   750e                 | jne                 0x10
            //   8b4d08               | mov                 ecx, dword ptr [ebp + 8]
            //   51                   | push                ecx
            //   8b4108               | mov                 eax, dword ptr [ecx + 8]

        $sequence_18 = { 33c9 8b4508 ba02000000 8b70f4 }
            // n = 4, score = 100
            //   33c9                 | xor                 ecx, ecx
            //   8b4508               | mov                 eax, dword ptr [ebp + 8]
            //   ba02000000           | mov                 edx, 2
            //   8b70f4               | mov                 esi, dword ptr [eax - 0xc]

        $sequence_19 = { 33c0 8bcb 034c2410 6a00 }
            // n = 4, score = 100
            //   33c0                 | xor                 eax, eax
            //   8bcb                 | mov                 ecx, ebx
            //   034c2410             | add                 ecx, dword ptr [esp + 0x10]
            //   6a00                 | push                0

        $sequence_20 = { eb09 3c20 7210 3c7f }
            // n = 4, score = 100
            //   eb09                 | jmp                 0xb
            //   3c20                 | cmp                 al, 0x20
            //   7210                 | jb                  0x12
            //   3c7f                 | cmp                 al, 0x7f

        $sequence_21 = { 6806040000 e9???????? 6a6f e9???????? }
            // n = 4, score = 100
            //   6806040000           | push                0x406
            //   e9????????           |                     
            //   6a6f                 | push                0x6f
            //   e9????????           |                     

        $sequence_22 = { 80780205 750b 80780306 7505 }
            // n = 4, score = 100
            //   80780205             | cmp                 byte ptr [eax + 2], 5
            //   750b                 | jne                 0xd
            //   80780306             | cmp                 byte ptr [eax + 3], 6
            //   7505                 | jne                 7

        $sequence_23 = { 83c404 881a 884a01 8bcb c1e910 c1eb18 884a02 }
            // n = 7, score = 100
            //   83c404               | add                 esp, 4
            //   881a                 | mov                 byte ptr [edx], bl
            //   884a01               | mov                 byte ptr [edx + 1], cl
            //   8bcb                 | mov                 ecx, ebx
            //   c1e910               | shr                 ecx, 0x10
            //   c1eb18               | shr                 ebx, 0x18
            //   884a02               | mov                 byte ptr [edx + 2], cl

        $sequence_24 = { 57 ff7608 ff15???????? 57 }
            // n = 4, score = 100
            //   57                   | push                edi
            //   ff7608               | push                dword ptr [esi + 8]
            //   ff15????????         |                     
            //   57                   | push                edi

        $sequence_25 = { 7409 b80b000280 5d c21000 8b4514 }
            // n = 5, score = 100
            //   7409                 | je                  0xb
            //   b80b000280           | mov                 eax, 0x8002000b
            //   5d                   | pop                 ebp
            //   c21000               | ret                 0x10
            //   8b4514               | mov                 eax, dword ptr [ebp + 0x14]

        $sequence_26 = { 57 881d???????? e8???????? 6a06 }
            // n = 4, score = 100
            //   57                   | push                edi
            //   881d????????         |                     
            //   e8????????           |                     
            //   6a06                 | push                6

        $sequence_27 = { 886de5 8b1485a0bf4200 8a4c1a2d f6c104 7419 8a441a2e }
            // n = 6, score = 100
            //   886de5               | mov                 byte ptr [ebp - 0x1b], ch
            //   8b1485a0bf4200       | mov                 edx, dword ptr [eax*4 + 0x42bfa0]
            //   8a4c1a2d             | mov                 cl, byte ptr [edx + ebx + 0x2d]
            //   f6c104               | test                cl, 4
            //   7419                 | je                  0x1b
            //   8a441a2e             | mov                 al, byte ptr [edx + ebx + 0x2e]

        $sequence_28 = { 3b0cc548fc4000 7427 40 83f82d 72f1 8d41ed }
            // n = 6, score = 100
            //   3b0cc548fc4000       | cmp                 ecx, dword ptr [eax*8 + 0x40fc48]
            //   7427                 | je                  0x29
            //   40                   | inc                 eax
            //   83f82d               | cmp                 eax, 0x2d
            //   72f1                 | jb                  0xfffffff3
            //   8d41ed               | lea                 eax, [ecx - 0x13]

    condition:
        7 of them and filesize < 843776
}